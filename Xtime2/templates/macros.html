{# movieCard的宏：一部影片的缩略图  #}
{% macro movieCard(thumbnail,title,rating,id) %}
    {#    id        : 影片id，跳转到影片详情页面 #}
    {#    thumbnail : 影片封面图 #}
    {#    title     : 影片标题 #}
    {#    rating    : 影片评分 #}
    <div class="card movie-card">
        <a href={{ url_for('main.get_movie', movie_id=id) }} target="_blank">
            <img class="card-img-top" alt="{{ title }}" src="{{ thumbnail }}">
            <em class="icohot"></em>
            <i class="moviegrade">{{ rating }}</i>
        </a>
        <h5 class="card-title">
            <a href="{{ url_for('main.get_movie', movie_id=id) }}" target="_blank">{{ title }}</a>
        </h5>
    </div>
{% endmacro %}


{# movieList的宏：一行影片缩略图-#}
{% macro movieList(module_title, cards, show_num, category=category) %}
    {#    module_title      : 影片类型标题，电影/电视剧...#}
    {#    cards             : 传入的n个影片 #}
    {#    category          : 影片类型，用int类型区分#}
    {#    show_num          : 要展示的影片缩略图数量#}

    {#            <span class="module-title">{{ module_title }}</span>#}
    {#            <a href="{{ url_for("main.item_list",category=category) }}" class="more-btn">更多</a>#}
    <!-- 影片缩略图：一共6个缩略图 -->
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                {% set len = (show_num|int) %}
                {% for card in cards[0: len] %}
                    <div class="col-md-2">
                        {#                        {{ cardGroup(card.thumbnail, card.title, card.rating, card.id) }}#}
                        {{ movieCard(card.thumbnail, card.title, card.rating, card.id) }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endmacro %}




{# reviewCard的宏：一个影评的缩略图  #}
{% macro reviewCard(thumbnail,title,rating, author,id="#") %}
    {#    thumbnail : 影片封面图 #}
    {#    title     : 影片标题 #}
    {#    rating    : 影片评分 #}
    {#    author    : 作者(包括用户名、其个人中心链接) #}
    {#    review_detail : 影评内容 #}
    {#    id        : 影评id，跳转到影评详情页面。调用方式为url_for('review', url=id) #}
    <div class="col-md-6" style="padding-right: 0px;">
        <div class="card commentsmod">
            <!-- 热门影评相关的影片图片 -->
            <a href="#" target="_blank">
                <img src="{{ thumbnail }}" title="{{ title }}" alt="{{ title }}" width="105px"
                     height="130px">
            </a>
            <!-- 热门影评首段 + 影片具体信息 -->
            <div class="col-md-8">
                <div class="card-block" style="padding: 0px;padding-top: 5px;">
                    <a class="describe" href="{{ id }}">
                        <i></i>
                        这部剧场版还真的是冲着东京奥运会去的，奥运会延期一年，这片儿也跟着跑路，非要在奥运会正式开幕之前，去折腾一下奥运会主场馆。然而本以为这一次会让大艺术家迪达拉看得上眼，不承想连个响都没听到。
                        本片副标题绯色的子弹，懂得人自然知道指的是谁。但别以为这部剧场版就跟黑衣组织有关了，其实这一次只是FBI的主场，犯罪目的是奔着FBI局长去的。
                    </a>
                    <p class="describemovie">
                        <a href="#">Mosquito史歌</a>
                        评 《<a href="#">名侦探柯南：绯色的子弹</a>》
                        <i class="moviegrade">&nbsp;6.9&nbsp;</i>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <a href={{ id }} target="_blank">
            <img class="card-img-top" alt="{{ title }}" src="{{ thumbnail }}">
            <em class="icohot"></em>
            <i class="moviegrade">{{ rating }}</i>
        </a>
        <h5 class="card-title">
            <a href={{ id }} target="_blank">{{ title }}</a>
        </h5>
    </div>
{% endmacro %}


{# reviewList的宏：一行影片缩略图-#}
{% macro reviewList(module_title, cards, show_num, category=category) %}
    {#    module_title      : 影片类型标题，电影/电视剧...#}
    {#    cards             : 传入的n个影片 #}
    {#    category          : 影片类型，用int类型区分#}
    {#    show_num          : 要展示的影片缩略图数量#}

{% endmacro %}



{# longReviewCard的宏：一个长影评的缩略图(显示某部影片的所有影评用到)  #}
{% macro longReviewCard(review, index) %}
    <li data-review_id={{ review.id }}>
        {% if index <= 2 %}
            <div class="sign">
                <span>TOP</span>
                <h3>{{ index }}</h3>
            </div>
        {% else %}
            <div class="sign not-hot">
                <span></span>
                <h3></h3>
            </div>
        {% endif %}
        <div class="matter">
            <div class="flex">
                <div class="reviewContent">
                    <p class="title"><a
                            href={{ url_for('main.show_review', review_id=review.id) }}>{{ review.title }}</a>
                    </p>
                    <div class="content">
                        {% if review.content|length < 150 %}
                            {{ review.content|striptags|safe }}
                        {% else %}
                            {{ review.content|striptags|safe|truncate(150, true) }}
                        {% endif %}
                    </div>
                </div>
                <div class="user">
                    <a href="#" target="_blank">
                        <img src={{ review.user.photo|string }}>
                    </a>
                    <div class="userInfo">
                        <p>
                            <a target="_blank" href="#">
                                {{ review.user.username }}
                            </a>
                        </p>
                        <p class="time">{{ review.modify_time.date() }}</p>
                    </div>
                </div>
            </div>
            <div class="tools">
                            <span>
                                <i class="bi bi-hand-thumbs-up-fill praise"></i>
                                <span>{{ review.fav_nums }}</span>
                            </span>
                <a href="#">
                    <i class="reviewIcon bi bi-chat-dots-fill"></i>
                    <span>119</span>
                </a>
            </div>
        </div>
    </li>
{% endmacro %}


{# longReviewList的宏：一个长影评的缩略图(显示某部影片的所有影评用到)  #}
{% macro longReviewList(reviews, show_num) %}
    <ul class="reviewList">
        <!-- python会确定列表长度和show_num的大小，取一个小的 -->
        {% for review in reviews[:show_num] %}
            {{ longReviewCard(review, loop.index) }}
        {% endfor %}
    </ul>
{% endmacro %}


{# ReviewHeader的宏：影评页面的header部分  #}
{% macro ReviewHeader(review, movie, user) %}
    <!-- 影评header部分 -->
    <div class="container-fluid review-header">
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4 bg-dark text-white">
                    {# 网上定制一张780 * 270的背景图#}
                    {#                    <img class="card-img" src="//placeimg.com/780/270/any" alt="Card image">#}
                    <div class="card-img-overlay" style="padding: 0">
                        <h1 class="mt-3 pb-3 mb-4 border-bottom">
                            {{ review.title }}
                        </h1>
                        <p class="card-text">
                            <span>{{ review.modify_time.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <span><a href="#">{{ user.username }}</a>发布的影评</span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-4 bg-dark text-white">
                    <img class="card-img movie-img" src={{ movie.image }} alt={{ movie.name }}>
                    <div class="card-img-overlay">
                        <h5 class="card-title"><a
                                href={{ url_for('main.get_movie', movie_id=movie.id) }}>{{ movie.name }}</a>({{ movie.release_date.year }})
                        </h5>
                        <p class="card-text">类型：{% for tag in movie.tags[:-1] %}{{ tag.name }}
                            /{% endfor %}{{ movie.tags[-1].name }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}


{% macro CommentFormCard(review_id, comment_id, form, rows) %}
    <div class="card-body comment-form">
        {% if comment_id %}
            <!-- 评论回复 -->
            <form method="post" action="{{ url_for('main.reply_comment', comment_id=comment_id) }}">
        {% else %}
            <!-- 发表评论 -->
            <form method="post" action="{{ url_for('main.show_review', review_id=review_id) }}">
        {% endif %}
        {{ form.csrf_token() }}
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="posts" role="tabpanel"
                 aria-labelledby="posts-tab">
                <div class="form-group">
                        <textarea class="form-control" id="message" rows="{{ rows }}" name="content"
                                  maxlength="400" placeholder="留下你想说的" required
                                  style="resize: none;min-height: 36px"></textarea>
                </div>
            </div>
        </div>
        <div class="text-right">
            <button type="submit" name="submit" class="btn btn-primary">确定</button>
        </div>
        </form>
    </div>
{% endmacro %}


{# SecondaryCommentCard的宏：二级评论 #}
{# 该宏和CommentCard很相似，考虑重构 #}
{% macro SecondaryCommentCard(comment, form) %}
    <div class="card card-inner">
        <div class="card-body">
            <div class="row">
                <div class="col-md-1">
                    <img src="{{ comment.user.photo }}" style="width: 33px;height: 33px;border-radius: 50%"
                         class="img img-rounded img-fluid"/>
                </div>
                <div class="col-md-11">
                    <p>
                        <a href="#"><strong>{{ comment.user.username }}</strong></a>
                        &nbsp;&nbsp;{{ comment.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                    </p>
                    <p style="margin-bottom: 0em;">{{ comment.content }}</p>
                    <p>
                        <a class="float-right btn btn-outline-primary ml-2"> <i
                                class="bi bi-reply"></i> 回复</a>
                        <a class="float-right btn text-white btn-danger">
                            <i class="bi bi-hand-thumbs-up-fill">喜欢</i>
                        </a>
                        <!-- 显示回复表单(隐藏功能通过jQuery的hide方法实现) -->
                        {{ CommentFormCard(comment.review_id, comment.id, form, 1) }}
                    </p>
                </div>
            </div>
        </div>
    </div>

{% endmacro %}


{# CommentCard的宏：评论 #}
{% macro CommentCard(comment, form) %}
    <!-- 参考：[Bootstrap 4 User Rating Form / Comment Form](https://bootsnipp.com/snippets/M5obX) -->
    <div class="card comment">
        <div class="card-body">
            <!-- 一级评论 -->
            <div class="row">
                <div class="col-md-1">
                    <img src="{{ comment.user.photo }}" style="width: 40px;height: 40px;border-radius: 50%"
                         class="img img-rounded img-fluid"/>
                </div>
                <div class="col-md-11">
                    <p>
                        <a class="float-left" href="#"><strong>{{ comment.user.username }}</strong></a>&nbsp;
{#                        &nbsp;&nbsp;{{ comment.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}#}
                        <!-- 解决在macro中UndefinedError: 'moment' is undefined的问题 -->
{#                        <!-- 通过使用context导入宏 such as{% from "your_macro_file" import render_file_thumbnail with context %} -->#}
{#                        {{ moment(comment.timestamp).fromNow() }}#}
{#                        {{ moment(comment.timestamp).format('L') }}#}
{#                        {{ moment(comment.timestamp).format('LL') }}#}
{#                        {{ moment(comment.timestamp).format('LLL') }}#}
                        {{ moment(comment.timestamp).format('LLLL') }}
                    </p>
                    <div class="clearfix"></div>
                    <p style="margin-bottom:0em">{{ comment.content }}</p>
                    <p>
                        <button type="button" class="float-right btn btn-outline-primary ml-2" id="reply">
                            <i class="bi bi-reply"></i>回复
                        </button>
                        <a class="float-right btn text-white btn-danger">
                            <i class="bi bi-hand-thumbs-up-fill">{{ comment.fav_nums }}喜欢</i>
                        </a>
                        <!-- 显示回复表单(隐藏功能通过jQuery的hide方法实现) -->
                        {{ CommentFormCard(comment.review_id, comment.id, form, 1) }}
                    </p>
                </div>
            </div>
            <!-- 二级评论 -->
            {% for reply in comment.replies %}
                {{ SecondaryCommentCard(reply, form) }}
            {% endfor %}
        </div>
    </div>
{% endmacro %}


{# CommentList的宏：某个影评的所有评论 #}
{% macro CommentList(comments, form, show_num) %}
    <ul class="commentList">
        {% if not show_num %}
            {% for comment in comments %}
                {{ CommentCard(comment, form) }}
            {% endfor %}
        {% else %}
            {% for comment in comments[:show_num] %}
                {{ CommentCard(comment, form) }}
            {% endfor %}
        {% endif %}
    </ul>
{% endmacro %}




{# 固定侧边栏(点赞/点踩/收藏/留言/分享/返回顶部) #}
{% macro XtimeSideBar(review) %}
    <div class="newXtimebar" data-review_id={{ review.id|string }}>
        <div class="praise" title="点赞">
            <i class="bi bi-hand-thumbs-up-fill" id="praise"></i>
            <p>{{ review.fav_nums }}</p></div>
        <div class="step" title="点踩">
            <i class="bi bi-hand-thumbs-down-fill" id="step"></i>
            <p>{{ review.dislike_nums }}</p></div>
        <div class="collectbar" title="收藏" style="display: none"><i></i>
            <p>{{ review.collect_nums }}</p></div>
        <div class="messagebar" title="留言"><i class="bi bi-chat-dots-fill"></i>
            <p>{{ review.comments|length }}</p></div>
        <div class="share" title="分享"><i class="bi bi-share-fill"></i>
            <p></p></div>
        <div class="topbar" title="返回顶部"><i class="bi bi-chevron-up back-to-top"></i>
            <p></p></div>
    </div>
{% endmacro %}
